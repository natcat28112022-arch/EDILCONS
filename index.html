<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edil-Construct | Gestiune Integrată v23.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .order-card { background: linear-gradient(145deg, #0f172a 0%, #020617 100%); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .tab-active { background-color: #2563eb !important; color: white !important; transform: scale(1.05); }
        .italic-force { font-style: italic; font-weight: 800; text-transform: uppercase; }
        .status-badge { position: absolute; top: -2px; right: 4px; background: #ef4444; color: white; font-size: 9px; font-weight: 900; min-width: 17px; height: 17px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #020617; }
        .numpad-btn { background: #1e293b; color: white; height: 60px; border-radius: 16px; font-size: 20px; font-weight: 800; display: flex; align-items: center; justify-content: center; }
        .comment-bubble { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 6px 10px; margin-top: 4px; border-left: 2px solid #3b82f6; }
        .calc-input { background: transparent; border-bottom: 1px solid #334155; color: white; font-size: 10px; width: 40px; text-align: center; }
        .debt-circle { width: 35px; height: 35px; border-radius: 50%; background: #ef4444; border: 2px solid #f87171; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: white; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .count-badge-client { width: 20px; height: 20px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; margin-left: 6px; }
        .activity-badge { background: #10b981; color: white; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .pin-dot { transition: all 0.2s; }
    </style>
</head>
<body class="min-h-screen pb-24">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, deleteDoc, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBoL3iDvn36GW-gEISwRSqhDldIOQqFXT8",
            authDomain: "edil-construct.firebaseapp.com",
            projectId: "edil-construct",
            storageBucket: "edil-construct.firebasestorage.app",
            messagingSenderId: "826446471916",
            appId: "1:826446471916:web:c3a25de0afec4b7f49bbc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const USER_PASSWORDS = { 'BIROU': '6766', 'SEFU': '1980', 'VICTOR': '3666', 'MIHAI': '1212', 'NELU': '1717', 'DIMON': '9898', 'VASILE': '0000', 'CONTABILITATE': '3322' };
        const SALARY_RATES = { 'SEFU': 1000, 'VICTOR': 814.81, 'BIROU': 814.81, 'MIHAI': 700, 'NELU': 700, 'VASILE': 600, 'CONTABILITATE': 600, 'DIMON': 550 };
        const HAMALI = ['VASILE', 'DIMON', 'CONTABILITATE'];

        const STATUS_CONFIG = {
            'actuale': { label: 'ACTUALE', icon: 'list-todo', color: 'border-blue-500' },
            'receptionat': { label: 'RECEPȚIE', icon: 'package-check', color: 'border-amber-500' },
            'incarcat': { label: 'ȘOFERI', icon: 'truck', color: 'border-cyan-500' },
            'livrate': { label: 'LIVRATE', icon: 'check-check', color: 'border-emerald-500' },
            'returnate': { label: 'RETUR', icon: 'refresh-cw', color: 'border-rose-500' },
            'primit': { label: 'DEPOZIT', icon: 'warehouse', color: 'border-orange-400' },
            'cereri': { label: 'CERERI ANGAJAȚI', icon: 'bell-ring', color: 'border-purple-500' }, 
            'datornici': { label: 'DATORNICI', icon: 'user-minus', color: 'border-rose-600' },
            'achitate': { label: 'ACHITATE', icon: 'user-check', color: 'border-emerald-600' },
            'salarii': { label: 'SALARII', icon: 'wallet', color: 'border-emerald-500' },
            'istoric': { label: 'ISTORIC', icon: 'archive', color: 'border-indigo-600' }
        };

        let state = { 
            userName: localStorage.getItem('flux_username') || '', 
            isClient: localStorage.getItem('is_client') === 'true',
            activeTab: 'actuale', items: [], salaries: {},
            showAddModal: false, loginMode: 'PORTAL', pinBuffer: '', clientPhone: '', hasWelcomed: false, expandedId: null, loginUserSelected: null
        };

        function speakWelcome(user, stats) {
            if (state.hasWelcomed || state.isClient) return;
            const synth = window.speechSynthesis;
            let msgText = user === 'SEFU' 
                ? `Salut Nicolae. Compania ta astăzi a efectuat ${stats.todayCount} comenzi. La moment sunt ${stats.activeCount} comenzi active.` 
                : `Salut ${user}. Sunt ${stats.visibleCount} comenzi noi.`;
            if (stats.visibleCount === 0 && user !== 'SEFU') {
                msgText += " Dacă nu ai de lucru, fă inventariere la minim două articole din depozit și spune rezultatul la birou.";
            }
            const utterance = new SpeechSynthesisUtterance(msgText); 
            utterance.lang = 'ro-RO'; 
            utterance.rate = 0.9;
            synth.speak(utterance); 
            state.hasWelcomed = true;
        }

        window.updatePhoneState = (val) => { state.clientPhone = val; };
        window.startLogin = (u) => { state.loginUserSelected = u; state.pinBuffer = ''; state.loginMode = 'STAFF_PIN'; render(); };
        
        window.addPin = (digit) => { 
            if(state.pinBuffer.length < 4) { 
                state.pinBuffer += digit;
                const dots = document.querySelectorAll('.pin-dot');
                if(dots[state.pinBuffer.length-1]) dots[state.pinBuffer.length-1].classList.add('bg-blue-500');
                if(state.pinBuffer.length === 4) {
                    setTimeout(() => {
                        if(state.loginMode === 'PORTAL') window.handlePortalAuth();
                        else window.confirmStaffLogin();
                    }, 150);
                }
            } 
        };

        window.handlePortalAuth = () => {
            const phone = state.clientPhone.trim();
            if (phone === '0011' && state.pinBuffer === '1980') { state.loginMode = 'STAFF_LIST'; state.pinBuffer = ''; render(); }
            else {
                if (state.pinBuffer === phone.slice(-4) && phone.length > 5) { 
                    state.userName = phone; state.isClient = true; 
                    localStorage.setItem('flux_username', phone); localStorage.setItem('is_client', 'true'); render(); 
                } else { alert("EROARE!"); state.pinBuffer = ''; render(); }
            }
        };

        window.confirmStaffLogin = () => {
            if (state.pinBuffer === USER_PASSWORDS[state.loginUserSelected]) { 
                state.userName = state.loginUserSelected; state.isClient = false;
                localStorage.setItem('flux_username', state.userName); localStorage.setItem('is_client', 'false'); render(); 
            } else { alert("PIN INCORECT!"); state.pinBuffer = ''; render(); }
        };

        window.logout = () => { localStorage.clear(); state.userName = ''; state.hasWelcomed = false; state.loginMode = 'PORTAL'; render(); };
        window.setTab = (t) => { state.activeTab = t; state.expandedId = null; render(); };
        window.toggleExpand = (id) => { state.expandedId = (state.expandedId === id) ? null : id; render(); };
        window.toggleAdd = (s) => { state.showAddModal = s; render(); };

        window.addComment = async (e, id) => {
            if(e) e.stopPropagation();
            const inp = document.getElementById(`comment_input_${id}`);
            if(!inp || !inp.value.trim()) return;
            const txt = `[${new Date().toLocaleTimeString('ro-RO')}] ${state.userName}: ${inp.value.trim()}`;
            await updateDoc(doc(db, "flux_logistic_v3", id), { comments: arrayUnion(txt) });
            inp.value = '';
        };

        window.handleCheck = async (e, id) => {
            if(e) e.stopPropagation();
            const item = state.items.find(i => i.id === id);
            const log = `[${new Date().toLocaleString('ro-RO')}] Bifat de ${state.userName}`;
            await updateDoc(doc(db, "flux_logistic_v3", id), { checkedBy: item.checkedBy ? null : state.userName, history: arrayUnion(log) });
        };

        window.handleStatusChange = async (itemId, nextStatus) => {
            const log = `[${new Date().toLocaleString('ro-RO')}] ${state.userName} -> ${STATUS_CONFIG[nextStatus].label}`;
            let updateObj = { status: nextStatus, updatedAt: serverTimestamp(), checkedBy: null, history: arrayUnion(log) };
            if(nextStatus === 'livrate') updateObj.deliveredAt = new Date().toLocaleString('ro-RO');
            if(nextStatus === 'returnate') updateObj.returnedAt = new Date().toLocaleString('ro-RO');
            await updateDoc(doc(db, "flux_logistic_v3", itemId), updateObj);
        };

        window.toggleAttendance = async (user) => {
            const currentDays = state.salaries[user]?.daysWorked || 0;
            await setDoc(doc(db, "salarii", user), { daysWorked: currentDays + 1 }, { merge: true });
        };
        window.updateAdvanceStaff = async (user, val) => {
            await setDoc(doc(db, "salarii", user), { advance: parseFloat(val) || 0 }, { merge: true });
        };
        window.resetSalary = async (user) => {
            if(confirm(`Resetezi datele pentru ${user}?`)) await setDoc(doc(db, "salarii", user), { daysWorked: 0, advance: 0 }, { merge: true });
        };

        const recalculateOrder = (item) => {
            let matTotal = 0;
            item.materials.forEach(m => { if(m.calc) matTotal += (m.calc.qty * m.calc.days * m.calc.price); });
            let transTotal = (item.transport?.qty || 0) * (item.transport?.price || 0);
            item.totalSuma = matTotal + transTotal;
            item.restDePlata = item.totalSuma - (item.avans || 0);
        };

        window.updateMaterialCalc = async (itemId, matIdx, field, val) => {
            const item = state.items.find(i => i.id === itemId);
            if(!item.materials[matIdx].calc) item.materials[matIdx].calc = { qty: item.materials[matIdx].loaded || 0, days: 1, price: 0 };
            item.materials[matIdx].calc[field] = parseFloat(val) || 0;
            recalculateOrder(item);
            await updateDoc(doc(db, "flux_logistic_v3", itemId), { materials: item.materials, totalSuma: item.totalSuma, restDePlata: item.restDePlata });
        };

        window.updateTransport = async (itemId, field, val) => {
            const item = state.items.find(i => i.id === itemId);
            if(!item.transport) item.transport = { qty: 0, price: 0 };
            item.transport[field] = parseFloat(val) || 0;
            recalculateOrder(item);
            await updateDoc(doc(db, "flux_logistic_v3", itemId), { transport: item.transport, totalSuma: item.totalSuma, restDePlata: item.restDePlata });
        };

        window.updateOrderPayment = async (itemId, field, val) => {
            const v = parseFloat(val) || 0;
            const item = state.items.find(i => i.id === itemId);
            if(field === 'avans') {
                const total = item.totalSuma || 0;
                await updateDoc(doc(db, "flux_logistic_v3", itemId), { avans: v, restDePlata: total - v });
            }
        };

        window.updateQty = async (e, id, idx, val) => {
            if(e) e.stopPropagation();
            const item = state.items.find(i => i.id === id);
            item.materials[idx].loaded = parseFloat(val) || 0;
            await updateDoc(doc(db, "flux_logistic_v3", id), { materials: item.materials });
        };

        window.handleAddItem = async () => {
            const t = document.getElementById('add_t').value;
            const m_raw = document.getElementById('add_m').value;
            const p = document.getElementById('add_p').value;
            if(!t || !m_raw) return;
            const isBirou = (state.userName === 'BIROU' || state.userName === 'SEFU');
            const targetStatus = isBirou ? 'actuale' : 'cereri';
            const materials = m_raw.split('\n').filter(l => l.trim()).map(l => ({ qty: 1, name: l.trim(), loaded: 0, calc: {qty:0, days:1, price:0} }));
            await addDoc(collection(db, "flux_logistic_v3"), { 
                text: t, materials, phone: p, status: targetStatus, 
                createdAt: serverTimestamp(), updatedAt: serverTimestamp(), 
                comments: [], history: [`[${new Date().toLocaleString('ro-RO')}] Creată de ${state.userName}`],
                createdBy: state.userName
            });
            state.showAddModal = false;
        };

        window.handleDelete = async (e, id) => { if(e) e.stopPropagation(); if(confirm("Ștergi definitiv?")) await deleteDoc(doc(db, "flux_logistic_v3", id)); };

        function render() {
            const root = document.getElementById('root');
            if (!state.userName) renderLoginUI(root);
            else if (state.isClient) renderClientDashboard(root);
            else renderStaffDashboard(root);
            lucide.createIcons();
        }

        function renderLoginUI(root) {
            root.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-950">
                <h2 class="italic-force text-blue-500 mb-6">EDIL-CONSTRUCT</h2>
                ${state.loginMode === 'PORTAL' ? 
                    `<input type="tel" value="${state.clientPhone}" oninput="window.updatePhoneState(this.value)" class="w-full max-w-xs bg-slate-900 p-5 rounded-2xl text-center text-xl mb-6 border border-white/10 text-white outline-none" placeholder="TELEFON">` : 
                    (state.loginMode === 'STAFF_LIST' ? 
                        `<div class="grid grid-cols-2 gap-4 w-full max-w-sm">${Object.keys(USER_PASSWORDS).map(u => `<button onclick="window.startLogin('${u}')" class="py-8 bg-slate-900 rounded-3xl italic-force text-[11px] text-slate-300 border border-white/5">${u}</button>`).join('')}</div>` :
                        `<h3 class="text-white mb-4 uppercase font-bold">${state.loginUserSelected}</h3>`
                    )
                }
                ${state.loginMode !== 'STAFF_LIST' ? `
                    <div class="flex gap-4 mb-8">${[1,2,3,4].map(i => `<div class="pin-dot w-4 h-4 rounded-full ${state.pinBuffer.length >= i ? 'bg-blue-500 shadow-[0_0_15px_#3b82f6]' : 'bg-slate-800'}"></div>`).join('')}</div>
                    <div class="grid grid-cols-3 gap-3 w-full max-w-xs">${[1,2,3,4,5,6,7,8,9,0].map(n => `<button onclick="window.addPin('${n}')" class="numpad-btn">${n}</button>`).join('')}</div>
                    ${state.loginMode !== 'PORTAL' ? `<button onclick="state.loginMode='STAFF_LIST';render()" class="mt-4 text-slate-500 text-[10px] font-bold">ÎNAPOI</button>` : ''}
                ` : ''}
            </div>`;
        }

        function renderClientDashboard(root) {
            const clientOrders = state.items.filter(i => i.phone === state.userName);
            const activeOrders = clientOrders.filter(i => i.status !== 'istoric' && i.status !== 'achitate');
            const totalDebt = clientOrders.filter(i => i.status === 'datornici').reduce((acc, curr) => acc + (curr.restDePlata || 0), 0);

            root.innerHTML = `
                <header class="glass sticky top-0 z-50 px-4 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        ${totalDebt > 0 ? `<div class="debt-circle">${Math.round(totalDebt)}</div>` : ''}
                        <span class="italic-force text-blue-500 text-xs">CLIENT: ${state.userName}</span>
                    </div>
                    <button onclick="window.logout()" class="text-[9px] font-bold bg-white/10 px-3 py-1.5 rounded-full">IEȘIRE</button>
                </header>
                <div class="p-6 max-w-lg mx-auto">
                    ${activeOrders.length > 0 ? activeOrders.map(myOrder => `
                        <div class="order-card p-6 rounded-[2rem] border-l-4 ${STATUS_CONFIG[myOrder.status].color} mb-4">
                            <h2 class="text-xl font-black italic-force text-white mb-1">${myOrder.text}</h2>
                            <div class="mb-4 text-[9px] text-slate-400">
                                ${myOrder.deliveredAt ? `<div>LIVRAT: ${myOrder.deliveredAt}</div>` : ''}
                                ${myOrder.returnedAt ? `<div>RETUR: ${myOrder.returnedAt}</div>` : ''}
                            </div>
                            <div class="mb-6"><span class="bg-blue-600 px-3 py-1 rounded-full text-[9px] font-black uppercase">${STATUS_CONFIG[myOrder.status].label}</span></div>
                            <div class="bg-black/40 rounded-2xl p-4 mb-4 space-y-2">${(myOrder.materials || []).map(m => `<div class="flex justify-between text-xs"><span>${m.name}</span><b class="text-emerald-500">${m.loaded}/${m.qty}</b></div>`).join('')}</div>
                            ${myOrder.status === 'datornici' ? `<div class="text-right text-rose-500 font-black text-sm mb-2">DATORIE: ${Math.round(myOrder.restDePlata || 0)} L</div>` : ''}
                            <div class="mb-4 space-y-1">${(myOrder.comments || []).map(c => `<div class="comment-bubble text-[9px] text-blue-200">${c}</div>`).join('')}</div>
                            <div class="flex gap-2"><input id="comment_input_${myOrder.id}" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] outline-none text-white" placeholder="Mesaj către birou..."><button onclick="addComment(event, '${myOrder.id}')" class="bg-slate-800 px-3 rounded-lg"><i data-lucide="send" size="12"></i></button></div>
                        </div>`).join('') : `<div class="text-center py-20 text-slate-500 italic-force">NICIO COMANDĂ ACTIVĂ</div>`}
                </div>`;
        }

        function renderStaffDashboard(root) {
            const isBirou = (state.userName === 'BIROU' || state.userName === 'SEFU');
            const todayStr = new Date().toLocaleDateString('ro-RO');
            const todayActions = state.items.filter(i => i.updatedAt?.toDate().toLocaleDateString('ro-RO') === todayStr && (i.status === 'livrate' || i.status === 'primit')).length;
            const totalDebt = state.items.filter(i => i.status === 'datornici').reduce((acc, curr) => acc + (curr.restDePlata || 0), 0);
            
            const stats = { todayCount: todayActions, activeCount: state.items.filter(i => ['actuale', 'receptionat', 'incarcat', 'returnate'].includes(i.status)).length, visibleCount: state.items.filter(i => i.status === 'actuale').length };
            speakWelcome(state.userName, stats);

            root.innerHTML = `
                <header class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">${isBirou ? `<div class="debt-circle">${Math.round(totalDebt)}</div>` : ''}<span class="italic-force text-blue-500 text-xs">EDIL STAFF</span></div>
                    <div class="flex items-center gap-2"><div class="activity-badge">${todayActions}</div><button onclick="window.logout()" class="text-[9px] font-bold bg-white/5 px-3 py-1.5 rounded-full uppercase">${state.userName}</button></div>
                </header>
                <nav class="flex gap-2 overflow-x-auto px-4 py-2 sticky top-[53px] glass z-40 no-scrollbar">
                    ${Object.keys(STATUS_CONFIG).map(k => {
                        if ((k === 'datornici' || k === 'achitate' || k === 'salarii' || k === 'cereri') && !isBirou) return '';
                        const count = state.items.filter(i => i.status === k).length;
                        return `<button onclick="window.setTab('${k}')" class="relative flex flex-col items-center min-w-[72px] p-2 rounded-xl ${state.activeTab === k ? 'tab-active' : 'text-slate-500'}">
                            ${count > 0 && !['achitate','istoric','salarii'].includes(k) ? `<div class="status-badge">${count}</div>` : ''}
                            <i data-lucide="${STATUS_CONFIG[k].icon}" size="16"></i>
                            <span class="text-[8px] font-black mt-1 uppercase">${STATUS_CONFIG[k].label}</span>
                        </button>`;
                    }).join('')}
                </nav>
                <div class="p-4 max-w-2xl mx-auto">
                    ${renderPersonalSalaryCard()}
                    ${state.activeTab === 'salarii' ? renderSalariesPage() : 
                      state.items.filter(i => i.status === state.activeTab).map(item => renderOrderCard(item, isBirou)).join('')}
                    <button onclick="window.toggleAdd(true)" class="w-full bg-blue-600 py-4 rounded-xl italic-force text-[11px] mt-6 shadow-xl uppercase">+ COMANDĂ NOUĂ</button>
                </div>
                ${state.showAddModal ? renderAddModal() : ''}
            `;
        }

        function renderPersonalSalaryCard() {
            if (state.activeTab === 'salarii') return '';
            const s = state.salaries[state.userName] || { daysWorked: 0, advance: 0 };
            const rate = SALARY_RATES[state.userName] || 0;
            const total = (s.daysWorked * rate) - (s.advance || 0);
            return `<div class="px-0 py-2 mb-4">
                <div class="glass rounded-2xl p-3 flex justify-between items-center border border-white/5 bg-gradient-to-r from-slate-900/50 to-blue-900/10 text-[9px] font-bold uppercase">
                    <div class="text-center flex-1 border-r border-white/5"><div class="text-[7px] text-slate-500">Zile</div>${s.daysWorked}</div>
                    <div class="text-center flex-1 border-r border-white/5"><div class="text-[7px] text-rose-500">Avans</div>${s.advance || 0} L</div>
                    <div class="text-center flex-1"><div class="text-[7px] text-emerald-500">Rest</div><span class="text-emerald-400 font-black">${Math.round(total)} L</span></div>
                </div>
            </div>`;
        }

        function renderOrderCard(item, isBirou) {
            const isExpanded = state.expandedId === item.id;
            
            // Logica noua pentru numarul de comenzi per client in rubrica curenta
            let badgeHtml = '';
            if ((item.status === 'livrate' || item.status === 'datornici') && item.phone) {
                const sameClientCount = state.items.filter(i => i.phone === item.phone && i.status === item.status).length;
                if (sameClientCount > 1) {
                    badgeHtml = `<div class="count-badge-client">${sameClientCount}</div>`;
                }
            }

            return `
                <div onclick="toggleExpand('${item.id}')" class="order-card p-4 mb-3 rounded-2xl border-l-4 ${STATUS_CONFIG[item.status].color} ${isExpanded ? 'ring-2 ring-blue-500/20' : ''}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center">
                                <h3 class="italic-force text-white text-[11px]">${item.text}</h3>
                                ${badgeHtml}
                            </div>
                            <div class="flex gap-2 items-center">
                                <a href="tel:${item.phone}" onclick="event.stopPropagation()" class="text-blue-400 text-[10px] font-black italic underline">${item.phone || 'N/A'}</a>
                                ${item.checkedBy ? `<span class="bg-emerald-500 text-[7px] px-1 rounded text-black font-black">OK</span>` : ''}
                            </div>
                            <div class="text-[8px] font-bold mt-1 text-slate-500">
                                ${item.deliveredAt ? `<span class="text-emerald-500 mr-2">LIVRAT: ${item.deliveredAt}</span>` : ''}
                                ${item.returnedAt ? `<span class="text-rose-500">RETUR: ${item.returnedAt}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isBirou && item.restDePlata > 0 ? `<span class="text-emerald-400 font-black text-[10px]">${Math.round(item.restDePlata)}</span>` : ''}
                            <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" size="14" class="text-slate-600"></i>
                        </div>
                    </div>
                    ${isExpanded ? `
                        <div class="mt-4 pt-4 border-t border-white/5 space-y-4" onclick="event.stopPropagation()">
                            <div class="bg-black/40 rounded-xl p-3 space-y-2">
                                ${(item.materials || []).map((m, idx) => `
                                    <div class="flex flex-col gap-2 border-b border-white/5 pb-2">
                                        <div class="flex justify-between text-[10px]">
                                            <span class="text-slate-300">${m.name} (${m.qty})</span>
                                            ${['receptionat', 'returnate', 'primit'].includes(item.status) ? 
                                                `<input type="number" value="${m.loaded||0}" onchange="updateQty(event, '${item.id}', ${idx}, this.value)" class="w-10 bg-blue-900/30 border border-blue-500 rounded text-center text-blue-400 outline-none">` : 
                                                `<b class="text-emerald-500">${m.loaded||0}</b>`}
                                        </div>
                                        ${isBirou && (item.status === 'istoric' || item.status === 'datornici' || item.status === 'achitate') ? `
                                            <div class="flex gap-1 items-center">
                                                <input type="number" onchange="updateMaterialCalc('${item.id}', ${idx}, 'qty', this.value)" value="${m.calc?.qty || m.loaded}" class="calc-input">
                                                <span class="text-[8px]">x</span>
                                                <input type="number" onchange="updateMaterialCalc('${item.id}', ${idx}, 'days', this.value)" value="${m.calc?.days || 1}" class="calc-input">
                                                <span class="text-[8px]">x</span>
                                                <input type="number" onchange="updateMaterialCalc('${item.id}', ${idx}, 'price', this.value)" value="${m.calc?.price || 0}" class="calc-input">
                                                <span class="text-[9px] font-bold text-emerald-500 ml-auto">= ${Math.round((m.calc?.qty||0)*(m.calc?.days||1)*(m.calc?.price||0))}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                ${isBirou && (item.status === 'istoric' || item.status === 'datornici' || item.status === 'achitate') ? `
                                    <div class="flex flex-col gap-2 pt-2 border-t border-white/10">
                                        <div class="flex justify-between text-[10px] text-blue-400 italic-force">TRANSPORT</div>
                                        <div class="flex gap-1 items-center">
                                            <input type="number" onchange="updateTransport('${item.id}', 'qty', this.value)" value="${item.transport?.qty || 0}" class="calc-input" placeholder="KM/H">
                                            <span class="text-[8px]">x</span>
                                            <input type="number" onchange="updateTransport('${item.id}', 'price', this.value)" value="${item.transport?.price || 0}" class="calc-input" placeholder="Pret">
                                            <span class="text-[9px] font-bold text-blue-400 ml-auto">= ${Math.round((item.transport?.qty||0)*(item.transport?.price||0))}</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            ${isBirou && (item.status === 'istoric' || item.status === 'datornici' || item.status === 'achitate') ? `
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white/5 p-2 rounded-lg"><label class="text-[7px] block text-slate-500 uppercase">Avans</label>
                                    <input type="number" value="${item.avans || 0}" onchange="updateOrderPayment('${item.id}', 'avans', this.value)" class="bg-transparent w-full text-xs font-bold text-blue-400 outline-none"></div>
                                    <div class="bg-emerald-500/10 p-2 rounded-lg text-right"><label class="text-[7px] block text-emerald-500 uppercase">Rest Plata</label><span class="text-xs font-black">${Math.round(item.restDePlata || 0)} L</span></div>
                                </div>` : ''}
                            <div class="space-y-1">${(item.comments || []).map(c => `<div class="comment-bubble text-[9px] text-blue-200">${c}</div>`).join('')}
                                <div class="flex gap-2 mt-2"><input id="comment_input_${item.id}" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] text-white outline-none" placeholder="Notă..."><button onclick="addComment(event, '${item.id}')" class="bg-slate-800 px-3 rounded-lg"><i data-lucide="send" size="12"></i></button></div>
                            </div>
                            <div class="text-[8px] text-slate-600 italic border-t border-white/5 pt-2">${(item.history || []).slice(-3).map(h => `<div>${h}</div>`).join('')}</div>
                            <div class="pt-2">${renderButtons(item, isBirou)}</div>
                        </div>` : ''}
                </div>`;
        }

        function renderButtons(item, isBirou) {
            const btn = "w-full py-3 rounded-xl mb-2 text-[9px] font-black italic-force ";
            const isSofer = ['MIHAI', 'VICTOR', 'NELU'].includes(state.userName);
            const isHamal = HAMALI.includes(state.userName);
            let h = "";

            if (isBirou) {
                h += `<div class="grid grid-cols-2 gap-2 mb-4">
                    ${Object.keys(STATUS_CONFIG).map(k => `<button onclick="handleStatusChange('${item.id}', '${k}')" class="py-2 rounded-lg bg-slate-800 text-[7px] font-black border border-white/5 uppercase">${STATUS_CONFIG[k].label}</button>`).join('')}
                </div>`;
            }

            if (['receptionat', 'incarcat', 'livrate', 'returnate', 'primit'].includes(item.status)) {
                h += `<button onclick="handleCheck(event, '${item.id}')" class="${btn} ${item.checkedBy ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-500'}">
                    ${item.checkedBy ? `CONFIRMAT DE: ${item.checkedBy}` : 'CONFIRMĂ PASUL'}</button>`;
            }
            if (item.status === 'actuale' && (isBirou || isHamal)) h += `<button onclick="handleStatusChange('${item.id}', 'receptionat')" class="${btn} bg-blue-600">LA RECEPȚIE</button>`;
            if (item.status === 'receptionat' && (isBirou || isHamal)) h += `<button onclick="handleStatusChange('${item.id}', 'incarcat')" class="${btn} bg-amber-600 text-black">LA ȘOFERI</button>`;
            if (item.status === 'incarcat' && (isBirou || isSofer)) h += `<button onclick="handleStatusChange('${item.id}', 'livrate')" class="${btn} bg-cyan-600">LIVRAT</button>`;
            if (item.status === 'returnate' && (isBirou || isSofer)) h += `<button onclick="handleStatusChange('${item.id}', 'primit')" class="${btn} bg-orange-500">LA DEPOZIT</button>`;
            
            if (isBirou) h += `<button onclick="handleDelete(event, '${item.id}')" class="w-full text-rose-900 text-[8px] mt-2">ȘTERGE COMANDĂ</button>`;
            return h;
        }

        function renderSalariesPage() {
            return Object.keys(SALARY_RATES).map(user => {
                const s = state.salaries[user] || { daysWorked: 0, advance: 0 };
                return `<div class="order-card p-4 rounded-2xl mb-4">
                    <div class="flex justify-between items-center mb-3"><b class="text-xs uppercase">${user}</b><button onclick="resetSalary('${user}')" class="text-[8px] bg-red-900/20 text-red-500 px-2 py-1 rounded">RESETEAZĂ</button></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="toggleAttendance('${user}')" class="bg-blue-600 rounded-xl p-3 text-center"><span class="text-xs font-black">${s.daysWorked} ZILE</span></button>
                        <div class="bg-black p-3 rounded-xl"><input type="number" value="${s.advance || 0}" onchange="updateAdvanceStaff('${user}', this.value)" class="bg-transparent w-full text-xs font-bold text-rose-400 outline-none" placeholder="AVANS"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAddModal() {
            return `<div class="fixed inset-0 bg-black/95 z-[100] p-6 flex items-center justify-center backdrop-blur-xl">
                <div class="bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 border border-white/10">
                    <h2 class="italic-force text-blue-500 mb-6 text-center">COMANDĂ NOUĂ</h2>
                    <input id="add_t" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none" placeholder="NUME CLIENT">
                    <textarea id="add_m" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-xs outline-none" rows="5" placeholder="MARFĂ (un rând pentru fiecare obiect)"></textarea>
                    <input id="add_p" class="w-full bg-black p-4 rounded-2xl text-white mb-8 text-sm outline-none" placeholder="TELEFON CLIENT">
                    <button onclick="window.handleAddItem()" class="w-full bg-blue-600 py-5 rounded-2xl italic-force text-xs mb-4">TRIMITE</button>
                    <button onclick="window.toggleAdd(false)" class="w-full text-slate-500 text-[10px] font-black uppercase">ANULARE</button>
                </div>
            </div>`;
        }

        signInAnonymously(auth).then(() => {
            onSnapshot(collection(db, "flux_logistic_v3"), s => { state.items = s.docs.map(d => ({id:d.id, ...d.data()})); render(); });
            onSnapshot(collection(db, "salarii"), s => { s.docs.forEach(d => { state.salaries[d.id] = d.data(); }); render(); });
        });
    </script>
</body>
</html>