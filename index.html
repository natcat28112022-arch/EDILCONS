<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edil-Construct | Gestiune Integrată</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .order-card { background: linear-gradient(145deg, #0f172a 0%, #020617 100%); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .tab-active { background-color: #2563eb !important; color: white !important; transform: scale(1.05); }
        .italic-force { font-style: italic; font-weight: 800; text-transform: uppercase; }
        .status-badge { position: absolute; top: -2px; right: 4px; background: #ef4444; color: white; font-size: 9px; font-weight: 900; min-width: 17px; height: 17px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #020617; }
        .numpad-btn { background: #1e293b; color: white; height: 60px; border-radius: 16px; font-size: 20px; font-weight: 800; display: flex; align-items: center; justify-content: center; }
        .comment-bubble { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 6px 10px; margin-top: 4px; border-left: 2px solid #3b82f6; }
        .calc-input { background: transparent; border-bottom: 1px solid #334155; color: white; font-size: 10px; width: 40px; text-align: center; }
        .debt-circle { width: 35px; height: 35px; border-radius: 50%; background: #ef4444; border: 2px solid #f87171; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; color: white; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .count-badge-client { width: 20px; height: 20px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; margin-left: 6px; }
        .activity-badge { background: #10b981; color: white; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .pin-dot { transition: all 0.2s; }
    </style>
</head>
<body class="min-h-screen pb-24">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, deleteDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBoL3iDvn36GW-gEISwRSqhDldIOQqFXT8",
            authDomain: "edil-construct.firebaseapp.com",
            projectId: "edil-construct",
            storageBucket: "edil-construct.firebasestorage.app",
            messagingSenderId: "826446471916",
            appId: "1:826446471916:web:c3a25de0afec4b7f49bbc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const USER_PASSWORDS = { 'BIROU': '6766', 'SEFU': '1980', 'VICTOR': '3666', 'MIHAI': '1212', 'NELU': '1717', 'DIMON': '9898', 'VASILE': '0000', 'CONTABILITATE': '3322' };
        const SALARY_RATES = { 'SEFU': 1000, 'VICTOR': 814.81, 'BIROU': 814.81, 'MIHAI': 700, 'NELU': 700, 'VASILE': 600, 'CONTABILITATE': 600, 'DIMON': 550 };
        const HAMALI = ['VASILE', 'DIMON', 'CONTABILITATE'];

        const STATUS_CONFIG = {
            'actuale': { label: 'ACTUALE', icon: 'list-todo', color: 'border-blue-500' },
            'receptionat': { label: 'RECEPȚIE', icon: 'package-check', color: 'border-amber-500' },
            'incarcat': { label: 'ȘOFERI', icon: 'truck', color: 'border-cyan-500' },
            'livrate': { label: 'LIVRATE', icon: 'check-check', color: 'border-emerald-500' },
            'returnate': { label: 'RETUR', icon: 'refresh-cw', color: 'border-rose-500' },
            'primit': { label: 'DEPOZIT', icon: 'warehouse', color: 'border-orange-400' },
            'cereri': { label: 'CERERI', icon: 'bell-ring', color: 'border-purple-500' }, 
            'datornici': { label: 'DATORNICI', icon: 'user-minus', color: 'border-rose-600' },
            'achitate': { label: 'ACHITATE', icon: 'user-check', color: 'border-emerald-600' },
            'stocuri': { label: 'STOCURI', icon: 'boxes', color: 'border-slate-400' },
            'salarii': { label: 'SALARII', icon: 'wallet', color: 'border-emerald-500' },
            'istoric': { label: 'ISTORIC', icon: 'archive', color: 'border-indigo-600' }
        };

        let state = { 
            userName: localStorage.getItem('flux_username') || '', 
            isClient: localStorage.getItem('is_client') === 'true',
            activeTab: 'actuale', items: [], salaries: {}, stocks: [],
            showAddModal: false, showStockModal: false, showConsumeModal: false,
            loginMode: 'PORTAL', pinBuffer: '', clientPhone: '', hasWelcomed: false, expandedId: null, loginUserSelected: null,
            newOrderMaterials: [] 
        };

        /* --- AUTH & INIT --- */
        window.updatePhoneState = (val) => { state.clientPhone = val; };
        window.startLogin = (u) => { state.loginUserSelected = u; state.pinBuffer = ''; state.loginMode = 'STAFF_PIN'; render(); };
        
        window.addPin = (digit) => { 
            if(state.pinBuffer.length < 4) { 
                state.pinBuffer += digit;
                const dots = document.querySelectorAll('.pin-dot');
                if(dots[state.pinBuffer.length-1]) dots[state.pinBuffer.length-1].classList.add('bg-blue-500');
                if(state.pinBuffer.length === 4) {
                    setTimeout(() => {
                        if(state.loginMode === 'PORTAL') window.handlePortalAuth();
                        else window.confirmStaffLogin();
                    }, 150);
                }
            } 
        };

        window.handlePortalAuth = () => {
            const phone = state.clientPhone.trim();
            if (phone === '0011' && state.pinBuffer === '1980') { state.loginMode = 'STAFF_LIST'; state.pinBuffer = ''; render(); }
            else {
                if (state.pinBuffer === phone.slice(-4) && phone.length > 5) { 
                    state.userName = phone; state.isClient = true; 
                    localStorage.setItem('flux_username', phone); localStorage.setItem('is_client', 'true'); render(); 
                } else { alert("EROARE!"); state.pinBuffer = ''; render(); }
            }
        };

        window.confirmStaffLogin = () => {
            if (state.pinBuffer === USER_PASSWORDS[state.loginUserSelected]) { 
                state.userName = state.loginUserSelected; state.isClient = false;
                localStorage.setItem('flux_username', state.userName); localStorage.setItem('is_client', 'false'); render(); 
            } else { alert("PIN INCORECT!"); state.pinBuffer = ''; render(); }
        };

        window.logout = () => { localStorage.clear(); state.userName = ''; state.hasWelcomed = false; state.loginMode = 'PORTAL'; render(); };
        window.setTab = (t) => { state.activeTab = t; state.expandedId = null; render(); };
        window.toggleExpand = (id) => { state.expandedId = (state.expandedId === id) ? null : id; render(); };
        window.toggleAdd = (s) => { state.showAddModal = s; state.newOrderMaterials = []; render(); };

        /* --- STOCK LOGIC --- */
        window.toggleStockModal = (s) => { state.showStockModal = s; render(); };
        window.toggleConsumeModal = (s, stockId) => { state.showConsumeModal = s ? stockId : null; render(); };

        window.handleAddStock = async () => {
            const name = document.getElementById('st_name').value.trim();
            const qty = parseFloat(document.getElementById('st_qty').value) || 0;
            const supplier = document.getElementById('st_supp').value.trim();
            const price = parseFloat(document.getElementById('st_price').value) || 0;
            const isNew = document.getElementById('st_isnew').checked;
            const existingId = document.getElementById('st_exist_select')?.value;

            if (qty <= 0) return alert("Cantitate invalidă");
            const entryLog = { date: new Date().toLocaleString('ro-RO'), supplier, price, qty, addedBy: state.userName };

            if (!isNew && existingId) {
                const item = state.stocks.find(s => s.id === existingId);
                await updateDoc(doc(db, "stocuri", existingId), {
                    qty: (item.qty || 0) + qty,
                    historyIn: arrayUnion(entryLog),
                    updatedAt: serverTimestamp()
                });
            } else {
                if(!name) return alert("Nume obligatoriu");
                await addDoc(collection(db, "stocuri"), {
                    name, qty,
                    historyIn: [entryLog],
                    historyOut: [],
                    createdAt: serverTimestamp()
                });
            }
            state.showStockModal = false;
        };

        window.handleConsumeStock = async () => {
            const stockId = state.showConsumeModal;
            const qty = parseFloat(document.getElementById('c_qty').value) || 0;
            const cause = document.getElementById('c_cause').value.trim();
            
            if (qty <= 0 || !cause) return alert("Completează datele");
            const item = state.stocks.find(s => s.id === stockId);
            const log = { id: Date.now().toString(), date: new Date().toLocaleString('ro-RO'), cause, qty, user: state.userName, confirmed: false };

            await updateDoc(doc(db, "stocuri", stockId), {
                qty: (item.qty || 0) - qty,
                historyOut: arrayUnion(log)
            });
            state.showConsumeModal = null;
        };

        window.toggleConfirmConsume = async (e, stockId, logId, currentVal) => {
            if(e) e.stopPropagation();
            if(state.userName !== 'SEFU') return;
            if(currentVal) return;
            const item = state.stocks.find(s => s.id === stockId);
            const newHistory = item.historyOut.map(h => {
                if(h.id === logId) return { ...h, confirmed: true };
                return h;
            });
            await updateDoc(doc(db, "stocuri", stockId), { historyOut: newHistory });
        };

        /* --- ORDER & LOGISTICS --- */
        window.addToTempOrder = () => {
            const sel = document.getElementById('new_ord_sel');
            const qty = document.getElementById('new_ord_qty');
            if(!sel.value || !qty.value) return;
            
            state.newOrderMaterials.push({
                name: sel.options[sel.selectedIndex].text.split('(')[0].trim(),
                stockId: sel.value,
                qty: parseFloat(qty.value),
                loaded: 0,
                calc: {qty:0, days:1, price:0}
            });
            qty.value = '';
            render();
        };

        window.handleAddItem = async () => {
            const t = document.getElementById('add_t').value;
            const p = document.getElementById('add_p').value;
            if(!t || state.newOrderMaterials.length === 0) return alert("Completează numele și adaugă marfă!");
            const isBirou = (state.userName === 'BIROU' || state.userName === 'SEFU');
            const targetStatus = isBirou ? 'actuale' : 'cereri';
            
            await addDoc(collection(db, "flux_logistic_v3"), { 
                text: t, materials: state.newOrderMaterials, phone: p, status: targetStatus, 
                createdAt: serverTimestamp(), updatedAt: serverTimestamp(), 
                comments: [], history: [`[${new Date().toLocaleString('ro-RO')}] Creată de ${state.userName}`],
                createdBy: state.userName
            });
            state.showAddModal = false;
        };

        window.addComment = async (e, id) => {
            if(e) e.stopPropagation();
            const inp = document.getElementById(`comment_input_${id}`);
            if(!inp || !inp.value.trim()) return;
            const txt = `[${new Date().toLocaleTimeString('ro-RO')}] ${state.userName}: ${inp.value.trim()}`;
            await updateDoc(doc(db, "flux_logistic_v3", id), { comments: arrayUnion(txt) });
            inp.value = '';
        };

        window.handleCheck = async (e, id) => {
            if(e) e.stopPropagation();
            const item = state.items.find(i => i.id === id);
            const log = `[${new Date().toLocaleString('ro-RO')}] Bifat de ${state.userName}`;
            await updateDoc(doc(db, "flux_logistic_v3", id), { checkedBy: item.checkedBy ? null : state.userName, history: arrayUnion(log) });
        };

        window.handleStatusChange = async (itemId, nextStatus) => {
            const item = state.items.find(i => i.id === itemId);
            const oldStatus = item.status;
            
            if (nextStatus === 'livrate' && oldStatus !== 'livrate') {
                for (let m of item.materials) {
                    let stocItem = m.stockId ? state.stocks.find(s => s.id === m.stockId) : null;
                    if (!stocItem) stocItem = state.stocks.find(s => s.name.trim().toLowerCase() === m.name.trim().toLowerCase());
                    
                    if(stocItem) {
                        const amountToDeduct = (m.loaded && m.loaded > 0) ? parseFloat(m.loaded) : parseFloat(m.qty);
                        await updateDoc(doc(db, "stocuri", stocItem.id), { 
                            qty: (stocItem.qty || 0) - amountToDeduct 
                        });
                    }
                }
            }
            
            if (oldStatus === 'livrate' && nextStatus !== 'livrate') {
                for (let m of item.materials) {
                    let stocItem = m.stockId ? state.stocks.find(s => s.id === m.stockId) : null;
                    if (!stocItem) stocItem = state.stocks.find(s => s.name.trim().toLowerCase() === m.name.trim().toLowerCase());

                    if(stocItem) {
                        const amountToAdd = (m.loaded && m.loaded > 0) ? parseFloat(m.loaded) : parseFloat(m.qty);
                        await updateDoc(doc(db, "stocuri", stocItem.id), { 
                            qty: (stocItem.qty || 0) + amountToAdd 
                        });
                    }
                }
            }

            const log = `[${new Date().toLocaleString('ro-RO')}] ${state.userName} -> ${STATUS_CONFIG[nextStatus].label}`;
            let updateObj = { status: nextStatus, updatedAt: serverTimestamp(), checkedBy: null, history: arrayUnion(log) };
            if(nextStatus === 'livrate') updateObj.deliveredAt = new Date().toLocaleString('ro-RO');
            if(nextStatus === 'returnate') updateObj.returnedAt = new Date().toLocaleString('ro-RO');
            await updateDoc(doc(db, "flux_logistic_v3", itemId), updateObj);
        };

        /* --- SALARIES & CALC --- */
        window.toggleAttendance = async (user) => {
            const currentDays = state.salaries[user]?.daysWorked || 0;
            await setDoc(doc(db, "salarii", user), { daysWorked: currentDays + 1 }, { merge: true });
        };
        window.updateAdvanceStaff = async (user, val) => {
            await setDoc(doc(db, "salarii", user), { advance: parseFloat(val) || 0 }, { merge: true });
        };
        window.resetSalary = async (user) => {
            if(confirm(`Resetezi datele pentru ${user}?`)) await setDoc(doc(db, "salarii", user), { daysWorked: 0, advance: 0 }, { merge: true });
        };
        window.updateQty = async (e, id, idx, val) => {
            if(e) e.stopPropagation();
            const item = state.items.find(i => i.id === id);
            item.materials[idx].loaded = parseFloat(val) || 0;
            await updateDoc(doc(db, "flux_logistic_v3", id), { materials: item.materials });
        };
        window.handleDelete = async (e, id) => { 
            if(e) e.stopPropagation(); 
            if(confirm("Ștergi definitiv?")) {
                const item = state.items.find(i => i.id === id);
                if(item.status === 'livrate') {
                    for (let m of item.materials) {
                        let stocItem = m.stockId ? state.stocks.find(s => s.id === m.stockId) : state.stocks.find(s => s.name === m.name);
                        if(stocItem) {
                            const qty = (m.loaded > 0) ? m.loaded : m.qty;
                            await updateDoc(doc(db, "stocuri", stocItem.id), { qty: (stocItem.qty || 0) + qty });
                        }
                    }
                }
                await deleteDoc(doc(db, "flux_logistic_v3", id)); 
            }
        };

        /* --- RENDERING --- */
        function render() {
            const root = document.getElementById('root');
            if (!state.userName) renderLoginUI(root);
            else if (state.isClient) renderClientDashboard(root);
            else renderStaffDashboard(root);
            lucide.createIcons();
        }

        function renderLoginUI(root) {
            root.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-950">
                <h2 class="italic-force text-blue-500 mb-6">EDIL-CONSTRUCT</h2>
                ${state.loginMode === 'PORTAL' ? 
                    `<input type="tel" value="${state.clientPhone}" oninput="window.updatePhoneState(this.value)" class="w-full max-w-xs bg-slate-900 p-5 rounded-2xl text-center text-xl mb-6 border border-white/10 text-white outline-none" placeholder="TELEFON">` : 
                    (state.loginMode === 'STAFF_LIST' ? 
                        `<div class="grid grid-cols-2 gap-4 w-full max-w-sm">${Object.keys(USER_PASSWORDS).map(u => `<button onclick="window.startLogin('${u}')" class="py-8 bg-slate-900 rounded-3xl italic-force text-[11px] text-slate-300 border border-white/5">${u}</button>`).join('')}</div>` :
                        `<h3 class="text-white mb-4 uppercase font-bold">${state.loginUserSelected}</h3>`
                    )
                }
                ${state.loginMode !== 'STAFF_LIST' ? `
                    <div class="flex gap-4 mb-8">${[1,2,3,4].map(i => `<div class="pin-dot w-4 h-4 rounded-full ${state.pinBuffer.length >= i ? 'bg-blue-500 shadow-[0_0_15px_#3b82f6]' : 'bg-slate-800'}"></div>`).join('')}</div>
                    <div class="grid grid-cols-3 gap-3 w-full max-w-xs">${[1,2,3,4,5,6,7,8,9,0].map(n => `<button onclick="window.addPin('${n}')" class="numpad-btn">${n}</button>`).join('')}</div>
                    ${state.loginMode !== 'PORTAL' ? `<button onclick="state.loginMode='STAFF_LIST';render()" class="mt-4 text-slate-500 text-[10px] font-bold">ÎNAPOI</button>` : ''}
                ` : ''}
            </div>`;
        }

        function renderClientDashboard(root) {
            const clientOrders = state.items.filter(i => i.phone === state.userName);
            const activeOrders = clientOrders.filter(i => i.status !== 'istoric' && i.status !== 'achitate');
            const totalDebt = clientOrders.filter(i => i.status === 'datornici').reduce((acc, curr) => acc + (curr.restDePlata || 0), 0);

            root.innerHTML = `
                <header class="glass sticky top-0 z-50 px-4 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        ${totalDebt > 0 ? `<div class="debt-circle">${Math.round(totalDebt)}</div>` : ''}
                        <span class="italic-force text-blue-500 text-xs">CLIENT: ${state.userName}</span>
                    </div>
                    <button onclick="window.logout()" class="text-[9px] font-bold bg-white/10 px-3 py-1.5 rounded-full">IEȘIRE</button>
                </header>
                <div class="p-6 max-w-lg mx-auto">
                    ${activeOrders.length > 0 ? activeOrders.map(myOrder => `
                        <div class="order-card p-6 rounded-[2rem] border-l-4 ${STATUS_CONFIG[myOrder.status].color} mb-4">
                            <h2 class="text-xl font-black italic-force text-white mb-1">${myOrder.text}</h2>
                            <div class="mb-4 text-[9px] text-slate-400">
                                ${myOrder.deliveredAt ? `<div>LIVRAT: ${myOrder.deliveredAt}</div>` : ''}
                                ${myOrder.returnedAt ? `<div>RETUR: ${myOrder.returnedAt}</div>` : ''}
                            </div>
                            <div class="mb-6"><span class="bg-blue-600 px-3 py-1 rounded-full text-[9px] font-black uppercase">${STATUS_CONFIG[myOrder.status].label}</span></div>
                            <div class="bg-black/40 rounded-2xl p-4 mb-4 space-y-2">${(myOrder.materials || []).map(m => `<div class="flex justify-between text-xs"><span>${m.name}</span><b class="text-emerald-500">${m.loaded}/${m.qty}</b></div>`).join('')}</div>
                            ${myOrder.status === 'datornici' ? `<div class="text-right text-rose-500 font-black text-sm mb-2">DATORIE: ${Math.round(myOrder.restDePlata || 0)} L</div>` : ''}
                            <div class="mb-4 space-y-1">${(myOrder.comments || []).map(c => `<div class="comment-bubble text-[9px] text-blue-200">${c}</div>`).join('')}</div>
                            <div class="flex gap-2"><input id="comment_input_${myOrder.id}" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] outline-none text-white" placeholder="Mesaj către birou..."><button onclick="addComment(event, '${myOrder.id}')" class="bg-slate-800 px-3 rounded-lg"><i data-lucide="send" size="12"></i></button></div>
                        </div>`).join('') : `<div class="text-center py-20 text-slate-500 italic-force">NICIO COMANDĂ ACTIVĂ</div>`}
                </div>`;
        }

        function renderStaffDashboard(root) {
            const isBirou = (state.userName === 'BIROU' || state.userName === 'SEFU');
            const todayStr = new Date().toLocaleDateString('ro-RO');
            const todayActions = state.items.filter(i => i.updatedAt?.toDate().toLocaleDateString('ro-RO') === todayStr && (i.status === 'livrate' || i.status === 'primit')).length;
            const totalDebt = state.items.filter(i => i.status === 'datornici').reduce((acc, curr) => acc + (curr.restDePlata || 0), 0);
            
            root.innerHTML = `
                <header class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">${isBirou ? `<div class="debt-circle">${Math.round(totalDebt)}</div>` : ''}<span class="italic-force text-blue-500 text-xs">EDIL STAFF</span></div>
                    <div class="flex items-center gap-2"><div class="activity-badge">${todayActions}</div><button onclick="window.logout()" class="text-[9px] font-bold bg-white/5 px-3 py-1.5 rounded-full uppercase">${state.userName}</button></div>
                </header>
                <nav class="flex gap-2 overflow-x-auto px-4 py-2 sticky top-[53px] glass z-40 no-scrollbar">
                    ${Object.keys(STATUS_CONFIG).map(k => {
                        if ((k === 'datornici' || k === 'achitate' || k === 'salarii' || k === 'cereri' || k === 'stocuri') && !isBirou) return '';
                        const count = state.items.filter(i => i.status === k).length;
                        return `<button onclick="window.setTab('${k}')" class="relative flex flex-col items-center min-w-[72px] p-2 rounded-xl ${state.activeTab === k ? 'tab-active' : 'text-slate-500'}">
                            ${count > 0 && !['achitate','istoric','salarii','stocuri'].includes(k) ? `<div class="status-badge">${count}</div>` : ''}
                            <i data-lucide="${STATUS_CONFIG[k].icon}" size="16"></i>
                            <span class="text-[8px] font-black mt-1 uppercase">${STATUS_CONFIG[k].label}</span>
                        </button>`;
                    }).join('')}
                </nav>
                <div class="p-4 max-w-2xl mx-auto">
                    ${state.activeTab === 'stocuri' ? renderStocksPage() : 
                      state.activeTab === 'salarii' ? renderSalariesPage() : 
                      state.items.filter(i => i.status === state.activeTab).map(item => renderOrderCard(item, isBirou)).join('')
                    }
                    ${state.activeTab !== 'stocuri' && state.activeTab !== 'salarii' ? 
                      `<div class="mb-4">${renderPersonalSalaryCard()}</div>` : ''
                    }
                    ${state.activeTab !== 'stocuri' && state.activeTab !== 'salarii' ? 
                      `<button onclick="window.toggleAdd(true)" class="w-full bg-blue-600 py-4 rounded-xl italic-force text-[11px] mt-6 shadow-xl uppercase">+ COMANDĂ NOUĂ</button>` : ''
                    }
                </div>
                ${state.showAddModal ? renderAddModal() : ''}
                ${state.showStockModal ? renderStockModal() : ''}
                ${state.showConsumeModal ? renderConsumeModal() : ''}
            `;
        }

        function renderStocksPage() {
            const getActiveAtClients = (stockId, name) => {
                let total = 0;
                state.items.forEach(order => {
                    if (order.status === 'livrate' || order.status === 'datornici') {
                        order.materials.forEach(m => {
                            if (m.stockId === stockId || m.name === name) total += (m.loaded > 0 ? parseFloat(m.loaded) : parseFloat(m.qty));
                        });
                    }
                });
                return total;
            };

            return `
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-black italic-force text-white">MAGAZIE</h2>
                    <button onclick="window.toggleStockModal(true)" class="bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">+ INTRARE MARFĂ</button>
                </div>
                <div class="grid gap-3">
                    ${state.stocks.map(s => {
                        const atClient = getActiveAtClients(s.id, s.name);
                        return `
                        <div class="order-card p-4 rounded-2xl relative" onclick="toggleExpand('${s.id}')">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-black text-sm text-white uppercase">${s.name}</h3>
                                <button onclick="event.stopPropagation(); window.toggleConsumeModal(true, '${s.id}')" class="bg-rose-900/30 text-rose-500 border border-rose-500/30 px-3 py-1 rounded text-[9px] font-black uppercase">DECONTARE</button>
                            </div>
                            <div class="flex gap-2">
                                <div class="bg-emerald-900/20 border border-emerald-500/20 p-2 rounded-lg flex-1 text-center">
                                    <div class="text-[8px] text-emerald-500 font-bold uppercase">DEPOZIT</div>
                                    <div class="text-lg font-black text-white">${s.qty}</div>
                                </div>
                                <div class="bg-blue-900/20 border border-blue-500/20 p-2 rounded-lg flex-1 text-center">
                                    <div class="text-[8px] text-blue-500 font-bold uppercase">LA CLIENȚI</div>
                                    <div class="text-lg font-black text-white">${atClient}</div>
                                </div>
                            </div>
                            ${state.expandedId === s.id ? `
                                <div class="mt-4 pt-4 border-t border-white/5">
                                    <h4 class="text-[9px] font-bold text-blue-400 mb-2">ISTORIC INTRĂRI</h4>
                                    <div class="space-y-1 mb-4">
                                        ${(s.historyIn || []).map(h => `<div class="text-[8px] text-slate-400 flex justify-between bg-white/5 p-1 rounded"><span>${h.date} (${h.supplier})</span><span>${h.qty} buc x ${h.price} L</span></div>`).join('')}
                                    </div>
                                    <h4 class="text-[9px] font-bold text-rose-400 mb-2">ISTORIC DECONTĂRI</h4>
                                    <div class="space-y-1">
                                        ${(s.historyOut || []).map(h => `
                                            <div class="text-[9px] text-slate-300 flex justify-between items-center bg-white/5 p-2 rounded">
                                                <div class="flex flex-col">
                                                    <span class="font-bold">${h.cause}</span>
                                                    <span class="text-[8px] text-slate-500">${h.date} - ${h.qty} buc</span>
                                                </div>
                                                <button onclick="window.toggleConfirmConsume(event, '${s.id}', '${h.id}', ${h.confirmed})" 
                                                    class="${h.confirmed ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'} px-2 py-1 rounded text-[8px] font-black">
                                                    ${h.confirmed ? 'CONFIRMAT' : 'CONFIRMĂ'}
                                                </button>
                                            </div>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function renderStockModal() {
            return `<div class="fixed inset-0 bg-black/95 z-[100] p-6 flex items-center justify-center backdrop-blur-xl">
                <div class="bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 border border-white/10">
                    <h2 class="italic-force text-blue-500 mb-6 text-center">INTRARE MARFĂ</h2>
                    
                    <div class="flex gap-4 mb-4 justify-center">
                        <label class="text-[10px] font-bold"><input type="radio" name="st_type" id="st_isnew" onclick="render()" checked> NOUĂ</label>
                        <label class="text-[10px] font-bold"><input type="radio" name="st_type" onclick="render()"> EXISTENTĂ</label>
                    </div>

                    ${document.getElementById('st_isnew')?.checked !== false ? 
                        `<input id="st_name" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none" placeholder="NUME PRODUS">` : 
                        `<select id="st_exist_select" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none uppercase">
                            ${state.stocks.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>`
                    }
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input id="st_qty" type="number" class="bg-black p-4 rounded-2xl text-white text-sm outline-none" placeholder="CANTITATE">
                        <input id="st_price" type="number" class="bg-black p-4 rounded-2xl text-white text-sm outline-none" placeholder="PREȚ/BUC">
                    </div>
                    <input id="st_supp" class="w-full bg-black p-4 rounded-2xl text-white mb-8 text-sm outline-none" placeholder="FURNIZOR">
                    <button onclick="window.handleAddStock()" class="w-full bg-blue-600 py-5 rounded-2xl italic-force text-xs mb-4">SALVEAZĂ</button>
                    <button onclick="window.toggleStockModal(false)" class="w-full text-slate-500 text-[10px] font-black uppercase">ANULARE</button>
                </div>
            </div>`;
        }

        function renderConsumeModal() {
            const stockId = state.showConsumeModal;
            const item = state.stocks.find(s => s.id === stockId);
            return `<div class="fixed inset-0 bg-black/95 z-[100] p-6 flex items-center justify-center backdrop-blur-xl">
                <div class="bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 border border-white/10 border-rose-500/20">
                    <h2 class="italic-force text-rose-500 mb-2 text-center">DECONTARE</h2>
                    <p class="text-center text-xs text-slate-400 mb-6 uppercase">${item.name}</p>
                    <input id="c_cause" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none" placeholder="CAUZA (Ex: Uz personal, Defect)">
                    <input id="c_qty" type="number" class="w-full bg-black p-4 rounded-2xl text-white mb-8 text-sm outline-none" placeholder="CANTITATE">
                    <button onclick="window.handleConsumeStock()" class="w-full bg-rose-600 py-5 rounded-2xl italic-force text-xs mb-4">SCOATE DIN GESTIUNE</button>
                    <button onclick="window.toggleConsumeModal(false)" class="w-full text-slate-500 text-[10px] font-black uppercase">ANULARE</button>
                </div>
            </div>`;
        }

        function renderPersonalSalaryCard() {
            // Nu aratam pe tabul de salarii mare
            if (state.activeTab === 'salarii') return '';
            
            const s = state.salaries[state.userName] || { daysWorked: 0, advance: 0 };
            const rate = SALARY_RATES[state.userName];

            // Daca userul nu are salariu definit (ex: contabilitate e doar admin), nu aratam nimic
            if (!rate) return '';

            const earned = s.daysWorked * rate;
            const balance = earned - (s.advance || 0);

            // Logica culori
            const balanceColor = balance >= 0 ? 'text-emerald-400' : 'text-rose-400';
            const balanceLabel = balance >= 0 ? 'DE PRIMIT' : 'DATORIE';

            return `<div class="px-0 py-2 mb-2">
                <div class="glass rounded-2xl p-3 flex justify-between items-center border border-white/5 bg-gradient-to-r from-slate-900/50 to-blue-900/10 text-[9px] font-bold uppercase">
                    <div class="text-center flex-1 border-r border-white/5">
                        <div class="text-[7px] text-slate-500">Zile (${s.daysWorked})</div>
                        <div class="text-white">${Math.round(earned)} L</div>
                    </div>
                    <div class="text-center flex-1 border-r border-white/5">
                        <div class="text-[7px] text-rose-500">Avans</div>
                        <div class="text-rose-400">${s.advance || 0} L</div>
                    </div>
                    <div class="text-center flex-1">
                        <div class="text-[7px] ${balance >= 0 ? 'text-emerald-500' : 'text-rose-500'}">${balanceLabel}</div>
                        <span class="${balanceColor} font-black text-sm">${Math.round(Math.abs(balance))} L</span>
                    </div>
                </div>
            </div>`;
        }

        function renderOrderCard(item, isBirou) {
            const isExpanded = state.expandedId === item.id;
            let badgeHtml = '';
            if ((item.status === 'livrate' || item.status === 'datornici') && item.phone) {
                const sameClientCount = state.items.filter(i => i.phone === item.phone && i.status === item.status).length;
                if (sameClientCount > 1) badgeHtml = `<div class="count-badge-client">${sameClientCount}</div>`;
            }
            return `
                <div onclick="toggleExpand('${item.id}')" class="order-card p-4 mb-3 rounded-2xl border-l-4 ${STATUS_CONFIG[item.status].color} ${isExpanded ? 'ring-2 ring-blue-500/20' : ''}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center"><h3 class="italic-force text-white text-[11px]">${item.text}</h3>${badgeHtml}</div>
                            <div class="flex gap-2 items-center"><a href="tel:${item.phone}" onclick="event.stopPropagation()" class="text-blue-400 text-[10px] font-black italic underline">${item.phone || 'N/A'}</a>${item.checkedBy ? `<span class="bg-emerald-500 text-[7px] px-1 rounded text-black font-black">OK</span>` : ''}</div>
                            <div class="text-[8px] font-bold mt-1 text-slate-500">${item.deliveredAt ? `<span class="text-emerald-500 mr-2">LIVRAT: ${item.deliveredAt}</span>` : ''}${item.returnedAt ? `<span class="text-rose-500">RETUR: ${item.returnedAt}</span>` : ''}</div>
                        </div>
                        <div class="flex items-center gap-2">${isBirou && item.restDePlata > 0 ? `<span class="text-emerald-400 font-black text-[10px]">${Math.round(item.restDePlata)}</span>` : ''}<i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" size="14" class="text-slate-600"></i></div>
                    </div>
                    ${isExpanded ? `
                        <div class="mt-4 pt-4 border-t border-white/5 space-y-4" onclick="event.stopPropagation()">
                            <div class="bg-black/40 rounded-xl p-3 space-y-2">
                                ${(item.materials || []).map((m, idx) => `
                                    <div class="flex flex-col gap-2 border-b border-white/5 pb-2">
                                        <div class="flex justify-between text-[10px]">
                                            <span class="text-slate-300">${m.name} (${m.qty})</span>
                                            ${['receptionat', 'returnate', 'primit'].includes(item.status) ? `<input type="number" value="${m.loaded||0}" onchange="updateQty(event, '${item.id}', ${idx}, this.value)" class="w-10 bg-blue-900/30 border border-blue-500 rounded text-center text-blue-400 outline-none">` : `<b class="text-emerald-500">${m.loaded||0}</b>`}
                                        </div>
                                    </div>`).join('')}
                            </div>
                            <div class="pt-2">${renderButtons(item, isBirou)}</div>
                        </div>` : ''}
                </div>`;
        }

        function renderButtons(item, isBirou) {
            const btn = "w-full py-3 rounded-xl mb-2 text-[9px] font-black italic-force ";
            const isSofer = ['MIHAI', 'VICTOR', 'NELU'].includes(state.userName);
            const isHamal = HAMALI.includes(state.userName);
            let h = "";
            if (isBirou) h += `<div class="grid grid-cols-2 gap-2 mb-4">${Object.keys(STATUS_CONFIG).map(k => { if(k === 'stocuri') return ''; return `<button onclick="handleStatusChange('${item.id}', '${k}')" class="py-2 rounded-lg bg-slate-800 text-[7px] font-black border border-white/5 uppercase">${STATUS_CONFIG[k].label}</button>`; }).join('')}</div>`;
            if (['receptionat', 'incarcat', 'livrate', 'returnate', 'primit'].includes(item.status)) h += `<button onclick="handleCheck(event, '${item.id}')" class="${btn} ${item.checkedBy ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-500'}">${item.checkedBy ? `CONFIRMAT DE: ${item.checkedBy}` : 'CONFIRMĂ PASUL'}</button>`;
            if (item.status === 'actuale' && (isBirou || isHamal)) h += `<button onclick="handleStatusChange('${item.id}', 'receptionat')" class="${btn} bg-blue-600">LA RECEPȚIE</button>`;
            if (item.status === 'receptionat' && (isBirou || isHamal)) h += `<button onclick="handleStatusChange('${item.id}', 'incarcat')" class="${btn} bg-amber-600 text-black">LA ȘOFERI</button>`;
            if (item.status === 'incarcat' && (isBirou || isSofer)) h += `<button onclick="handleStatusChange('${item.id}', 'livrate')" class="${btn} bg-cyan-600">LIVRAT</button>`;
            if (item.status === 'returnate' && (isBirou || isSofer)) h += `<button onclick="handleStatusChange('${item.id}', 'primit')" class="${btn} bg-orange-500">LA DEPOZIT</button>`;
            if (isBirou) h += `<button onclick="handleDelete(event, '${item.id}')" class="w-full text-rose-900 text-[8px] mt-2">ȘTERGE COMANDĂ</button>`;
            return h;
        }

        function renderSalariesPage() {
            return Object.keys(SALARY_RATES).map(user => {
                const s = state.salaries[user] || { daysWorked: 0, advance: 0 };
                return `<div class="order-card p-4 rounded-2xl mb-4"><div class="flex justify-between items-center mb-3"><b class="text-xs uppercase">${user}</b><button onclick="resetSalary('${user}')" class="text-[8px] bg-red-900/20 text-red-500 px-2 py-1 rounded">RESETEAZĂ</button></div><div class="grid grid-cols-2 gap-3"><button onclick="toggleAttendance('${user}')" class="bg-blue-600 rounded-xl p-3 text-center"><span class="text-xs font-black">${s.daysWorked} ZILE</span></button><div class="bg-black p-3 rounded-xl"><input type="number" value="${s.advance || 0}" onchange="updateAdvanceStaff('${user}', this.value)" class="bg-transparent w-full text-xs font-bold text-rose-400 outline-none" placeholder="AVANS"></div></div></div>`;
            }).join('');
        }

        function renderAddModal() {
            const isBirou = (state.userName === 'BIROU' || state.userName === 'SEFU');
            return `<div class="fixed inset-0 bg-black/95 z-[100] p-6 flex items-center justify-center backdrop-blur-xl">
                <div class="bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 border border-white/10">
                    <h2 class="italic-force text-blue-500 mb-6 text-center">COMANDĂ NOUĂ</h2>
                    <input id="add_t" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none" placeholder="NUME CLIENT">
                    <input id="add_p" class="w-full bg-black p-4 rounded-2xl text-white mb-3 text-sm outline-none" placeholder="TELEFON CLIENT">
                    <div class="bg-white/5 p-4 rounded-2xl mb-4">
                        <h3 class="text-[10px] text-slate-400 mb-2 uppercase font-bold">Adaugă Materiale</h3>
                        <div class="flex gap-2 mb-2">
                            <select id="new_ord_sel" class="bg-black flex-1 p-2 rounded-lg text-xs outline-none uppercase text-white">
                                <option value="" disabled selected>Alege...</option>
                                ${state.stocks.map(s => `<option value="${s.id}">${s.name} ${isBirou ? `(Stoc: ${s.qty})` : ''}</option>`).join('')}
                            </select>
                            <input id="new_ord_qty" type="number" class="w-16 bg-black p-2 rounded-lg text-xs outline-none text-white text-center" placeholder="Cant.">
                            <button onclick="window.addToTempOrder()" class="bg-emerald-600 px-3 rounded-lg font-black">+</button>
                        </div>
                        <div class="max-h-32 overflow-y-auto space-y-1">
                            ${state.newOrderMaterials.map(m => `<div class="flex justify-between text-[10px] text-slate-300 bg-black/40 p-1 rounded px-2"><span>${m.name}</span><b>${m.qty}</b></div>`).join('')}
                        </div>
                    </div>
                    <button onclick="window.handleAddItem()" class="w-full bg-blue-600 py-5 rounded-2xl italic-force text-xs mb-4">TRIMITE</button>
                    <button onclick="window.toggleAdd(false)" class="w-full text-slate-500 text-[10px] font-black uppercase">ANULARE</button>
                </div>
            </div>`;
        }

        signInAnonymously(auth).then(() => {
            onSnapshot(collection(db, "flux_logistic_v3"), s => { state.items = s.docs.map(d => ({id:d.id, ...d.data()})); render(); });
            onSnapshot(collection(db, "salarii"), s => { s.docs.forEach(d => { state.salaries[d.id] = d.data(); }); render(); });
            onSnapshot(collection(db, "stocuri"), s => { state.stocks = s.docs.map(d => ({id:d.id, ...d.data()})); render(); });
        });
    </script>
</body>
</html>